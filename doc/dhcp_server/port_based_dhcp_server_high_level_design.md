# Port Based DHCP_SERVER in SONiC
# High Level Design Document
**Rev 0.1**

# Table of Contents
- [Port Based DHCP\_SERVER in SONiC](#port-based-dhcp_server-in-sonic)
- [High Level Design Document](#high-level-design-document)
- [Table of Contents](#table-of-contents)
- [Revision](#revision)
- [About this Manual](#about-this-manual)
- [Scope](#scope)
- [Definitions/Abbreviations](#definitionsabbreviations)
          - [Table 1: Abbreviations](#table-1-abbreviations)
- [1 Requirements Overview](#1-requirements-overview)
  - [1.1 Functional Requirements](#11-functional-requirements)
  - [1.2 Configuration and Management Requirements](#12-configuration-and-management-requirements)
- [2 Functionality](#2-functionality)
- [3 Design](#3-design)
  - [3.1 Design Overview](#31-design-overview)
  - [3.2 DB Changes](#32-db-changes)
    - [3.2.1 Config DB](#321-config-db)
      - [3.2.1.1 Yang Model](#3211-yang-model)
      - [3.2.1.2 DB Objects](#3212-db-objects)
    - [3.2.2 State DB](#322-state-db)
      - [3.2.2.1 Yang Model](#3221-yang-model)
      - [3.2.2.2 DB Objects](#3222-db-objects)
  - [3.3 Switch State Service Design](#33-switch-state-service-design)
    - [3.3.1 DhcpMgr Daemon](#331-dhcpmgr-daemon)
  - [3.4 Lease Update Script](#34-lease-update-script)
  - [3.5 DHCP Server Monitor](#35-dhcp-server-monitor)
  - [3.6 Flow Diagrams](#36-flow-diagrams)
    - [3.6.1 Config Change Flow](#361-config-change-flow)
    - [3.6.2 FDB Table Change Flow](#362-fdb-table-change-flow)
    - [3.6.3 Lease Update Flow](#363-lease-update-flow)
    - [3.6.3 Count Table Update Flow](#363-count-table-update-flow)
  - [3.7 CLI](#37-cli)
    - [3.7.1 Config CLI](#371-config-cli)
    - [3.7.2 Show CLI](#372-show-cli)
- [4 Unit test](#4-unit-test)

# Revision

| Rev |     Date    |       Author       | Change Description                  |
|:---:|:-----------:|:-------------------|:-----------------------------------|
| 0.1 |  2023/02/08 | Yaqiang Zhu, <br> Jing Kan       | Initial version                     |

# About this Manual

This document describes the design details of **ipv4 port based DHCP server** feature.
Dynamic Host Configuration Protocol (DHCP) server is used to centrally manage and configure IP addresses of clients dynamically. When server receives requests from DHCP-enabled clients, it would offer information to client about IP address, subnet mask, gateway etc.

# Scope
This document describes the high level design details about how **ipv4 port based DHCP server** works.

# Definitions/Abbreviations
###### Table 1: Abbreviations
| Abbreviation             | Full form                        |
|--------------------------|----------------------------------|
| DHCP                      | Dynamic Host Configuration Protocol      |

# 1 Requirements Overview
## 1.1 Functional Requirements
The requirements for DHCP server are: 

1.0 DHCP is standardized through RFC 1541, RFC 2131, RFC 2132.

2.0 Provide the ability to manage IP addresses.

2.1 Provide the ability to map client to IP address without conflicts, and mapping methods should be configurable.

2.2 Netmask, gateway, lease time of DHCP should be configurable per Vlan.

3.0 Provide counter of different type of DHCP packets to monitor whether DHCP server works well.

3.1 Provide ability to clear DHCP packets counter.

## 1.2 Configuration and Management Requirements
Configuration of DHCP server feature can be done via:
* JSON config input
* SONiC CLI

# 2 Functionality
DHCP server listens to port 68 and waits for messages from client. DHCP server and DHCP client complete IP address assignment through four-step packet interaction:
1. Discover

  DHCP client requesting DHCP IP for the first time does not know the IP address of DHCP server, and sends a DHCP DISCOVER packet in broadcast mode.

2. Offer
   
  DHCP server performs matching after receiving the DHCP DISCOVER packet, selects an available IP address for allocation according to the configuration, and sends a DHCP OFFER packet.

3. Request

  After DHCP client receives the OFFER packet, it sends a DHCP REQUEST packet in the form of broadcast, which contains information such as the DHCP server identifier and client address selected by the client.

4. Acknowledge

  After receiving the REQUEST packet from the client, the DHCP server responds with a DHCP ACK, indicating that the IP address requested in the REQUEST packet has been allocated successfully.

<div align="center"> <img src=images/dhcp_process.png width = 520 /> </div>

# 3 Design
## 3.1 Design Overview
The design overview at a high level is as below. The details are explained in the following subsections.
- Configuration tables for the DHCP server entries.
- Design is centered around the dnsmasq insides dhcp_relay container.
- Configuration file for dnsmasq is generated by related configuration tables.
- State tables for the DHCP server counter and lease entries.

## 3.2 DB Changes
### 3.2.1 Config DB
Following table changes would be added in Config DB, including **DHCP_SERVER_IPV4** table and **DHCP_SERVER_IPV4_PORT** table.

These new tables are introduced to specify configuration of DHCP Server.

#### 3.2.1.1 Yang Model
```yang
module sonic-dhcp-server-ipv4 {
  import ietf-inet-types {
        prefix inet;
  }
  container sonic-dhcp-server-ipv4 {
    container DHCP_SERVER_IPV4 {
      description "DHCP_SERVER_IPV4 part of config_db.json";
      list DHCP_SERVER_IPV4_LIST {
        key "name";
        leaf name {
          type string;
        }
        leaf gateway {
          description "Gateway of the DHCP server";
          type inet:ipv4-address;
        }
        leaf lease_time {
          description "Lease time of client for this DHCP server";
          type uint16;
        }
        leaf mode {
          description "Mode of assigning IP address";
          type string;
        }
        leaf netmask {
          description "Netmask of this DHCP server";
          type inet:ipv4-address;
        }
      }
    }
    /* end of container DHCP_SERVER_IPV4 */
    container DHCP_SERVER_IPV4_PORT {
      description "DHCP_SERVER_IPV4_PORT part of config_db.json";
      list PORT_LIST {
        key "name";
        leaf name {
          type string;
        }
        leaf ip {
          description "DHCP ip address assigned to this client";
          type inet:ipv4-address
        }
      }
    }
    /* end of container DHCP_SERVER_IPV4_PORT */
  }
  /* end of container sonic-dhcp-server-ipv4 */
}
```

#### 3.2.1.2 DB Objects
```JSON
{
  "DHCP_SERVER_IPV4": {
    "Vlan1000": {
      "gateway": "192.168.0.1",
      "lease_time": "180",
      "mode": "PORT",
      "netmask": "255.255.255.0"
    },
    "Ethernet15": {
      "gateway": "192.168.0.1",
      "lease_time": "180",
      "mode": "PORT",
      "netmask": "255.255.255.0"
    },
    "PortChannel1": {
      "gateway": "192.168.0.1",
      "lease_time": "180",
      "mode": "PORT",
      "netmask": "255.255.255.0"
    }
  },
  "DHCP_SERVER_IPV4_PORT": {
    "Vlan1000|Ethernet1": {
      "ip": "192.168.0.2"
    },
    "Vlan1000|Ethernet2": {
      "ip": "192.168.0.3"
    },
    "Ethernet15": {
      "ip": "192.168.0.4"
    },
    "PortChannel1": {
      "ip": "192.168.0.5"
    }
  }
}
```

### 3.2.2 State DB
Following table changes would be added in State DB, including **DHCP_SERVER_IPV4_COUNTER** table and **DHCP_SERVER_IPV4_LEASE** table.

These new tables are introduced to count different type of DHCP packet and record lease information.

#### 3.2.2.1 Yang Model
```yang
module sonic-dhcp-server-ipv4-counter {
  import ietf-inet-types {
        prefix inet;
  }
  container sonic-dhcp-server-ipv4-counter {
    container DHCP_SERVER_IPV4_COUNTER {
      description "DHCP_SERVER_IPV4_COUNTER part of state_db";
      list DHCP_SERVER_IPV4_COUNTER_LIST {
        key "name";
        leaf name {
          type string;
        }
        leaf recover {
          description "Count of recover packets receive";
          type uint16;
        }
        leaf offer {
          description "Count of offer packets send";
          type uint16;
        }
        leaf request {
          description "Count of request packets receive";
          type uint16;
        }
        leaf ack {
          description "Count of ack packets send";
          type uint16;
        }
      }
    }
    /* end of container DHCP_SERVER_IPV4_COUNTER */
    container DHCP_SERVER_IPV4_LEASE {
      description "DHCP_SERVER_IPV4_LEASE part of state_db";
      list DHCP_SERVER_IPV4_LEASE_LIST {
        key "name";
        leaf name {
          type string;
        }
        leaf lease_start {
          description "Unix time of lease start";
          type uint64
        },
        leaf ip {
          description "DHCP ip address assigned to this client";
          type inet:ipv4-address
        }
      }
    }
    /* end of container DHCP_SERVER_IPV4_COUNTER */
  }
  /* end of container sonic-dhcp-server-ipv4-counter */
}
```

#### 3.2.2.2 DB Objects
```JSON
{
  "DHCP_SERVER_IPV4_COUNTER": {
    "Vlan1000": {
      "recover": "0",
      "offer": "0",
      "request": "0",
      "ack": "0"
    },
    "Ethernet15": {
      "recover": "0",
      "offer": "0",
      "request": "0",
      "ack": "0"
    },
    "PortChannel1": {
      "recover": "0",
      "offer": "0",
      "request": "0",
      "ack": "0"
    }
  },
  "DHCP_SERVER_IPV4_LEASE": {
    "Vlan1000|10:70:fd:b6:13:00": {
      "lease_start": "1677640581",
      "ip": "192.168.0.1"
    },
    "Vlan1000|10:70:fd:b6:13:01": {
      "lease_start": "1677640581",
      "ip": "192.168.0.2"
    },
    "Ethernet1|10:70:fd:b6:13:02": {
      "lease_start": "1677640582",
      "ip": "192.168.0.3"
    }
  }
}
```

## 3.3 Switch State Service Design
### 3.3.1 DhcpMgr Daemon 
DhcpMgrd is daemon process to perform DHCP server related work. It gets the DHCP_SERVER_IPV4 config changes from CONFIG_DB and FDB_TABLE changes from STATE_DB. It is responseible for refreshing `dnsmasq.hosts` file and making this change takes effect while detecting DHCP_SERVER_IPV4 or FDB_TABLE change.
<div align="center"> <img src=images/dhcp_server_block_diagram.png width=570 /> </div>

The following figure describes how dhcpmgrd refreshes `dnsmasq.hosts`
<div align="center"> <img src=images/dnsmasq_update_flow_diagram.png width=530 /> </div>

## 3.4 Lease Update Script
Dnsmasq supports to specify a customize script to execute whenever a new DHCP lease is created, or an old one destroyed. We can update lease table in STATE_DB by this script.
<div align="center"> <img src=images/lease_update_flow_diagram.png width=380 /> </div>

## 3.5 DHCP Server Monitor
DHCP server monitor process is to periodically monitor work status of DHCP server.

* Monitor packet count

  Once dnsmasq receives or sends a DHCP packet, it would record it in logs. One job of DHCP server monitor is to monitor changes of dnsmasq logs, and according to this log to update counter table in STATE_DB and verify whether count of DHCP server packet sent or received is correct.

* Monitor critical process

  DHCP server monitor will periodically check whether processes of dnsmasq and dhcmpmgrd are working well.

* Check file `dnsmasq.hosts`

  DHCP server monitor will periodically check whether the generated file `dnsmasq.host` is consistent with the configuration in CONFIG_DB.

## 3.6 Flow Diagrams
### 3.6.1 Config Change Flow
This sequence figure describe the work flow for config_db changed CLI.
<div align="center"> <img src=images/config_change_flow.png width=580 /> </div>

### 3.6.2 FDB Table Change Flow
This sequence figure describe the work flow for state_db changed by new mac learnt.
<div align="center"> <img src=images/fdb_change_flow.png width=600 /> </div>

### 3.6.3 Lease Update Flow
This sequence figure describe the update work flow for updating lease table in STATE_DB when a new DHCP lease is created. Old lease modifying or deleting is same as new creating. 

<div align="center"> <img src=images/lease_update_flow.png width=560 /> </div>

### 3.6.3 Count Table Update Flow
This sequence figure describe the update work flow for updating packet counter table in STATE_DB.
<div align="center"> <img src=images/packet_counter_flow.png width=580 /> </div>

## 3.7 CLI
### 3.7.1 Config CLI
**config dhcp_server add**

This command is used to add dhcp_server for vlan
- Usage
  ```
  config dhcp_server ipv4 add [--mode <mode>] [--infer_gw_nm] [--lease_time <lease_time>] [--gateway <gateway>] [--netmask <netmask>] <interface>

  Options:
     mode: Specify mode of assign IP, currently only support 'PORT'. [required]
     lease_time: Time that the client can lease IP once. [not required, default value is 900(s)]
     infer_gw_nm: Indicate whether to use gateway and netmask of server interface. [not required if gateway and netmask is given and vlan]
     gateway: Gateway of DHCP server. [ignored if infer_gw_nm is given]
     netmask: Netmask of DHCP server. [ignored if infer_gw_nm is given]
  ```

- Example
  ```
  config dhcp_server ipv4 add --mode PORT --infer_gw_nm --lease_time 300 Vlan1000
  config dhcp_server ipv4 add --mode PORT --lease_time 300 --gateway 192.168.0.1 --netmask 255.255.255.0 Vlan1000
  ```

**config dhcp_server update**
This command is used to update dhcp_server config.
- Usage
  ```
  config dhcp_server ipv4 update [--mode <mode>] [--infer_gw_nm] [--lease_time <lease_time>] [--gateway <gateway>] [--netmask <netmask>] <interface>
  ```

- Example
  ```
  config dhcp_server ipv4 update --mode PORT --infer_gw_nm --lease_time 300 Vlan1000
  ```

**config dhcp_server**

This command is used to config dhcp ip per interface
- Usage
  ```
  config dhcp_server ipv4 <mode> [<vlan_interface>] <interface> <ip>
  ```

- Example
  ```
  config dhcp_server ipv4 PORT Vlan1000 Ethernet1 192.168.0.1
  config dhcp_server ipv4 PORT PortChannel1 192.168.0.1
  ```

**config dhcp_server del**

This command is used to delete all dhcp_server config for vlan
- Usage
  ```
  config dhcp_server ipv4 del <interface>
  ```

- Example
  ```
  config dhcp_server ipv4 del Vlan1000
  ```

### 3.7.2 Show CLI
**show dhcp_server info**

This command is used to show dhcp_server config
- Usage
  ```
  show dhcp_server ipv4 info [<interface>]
  ```

- Example
  ```
  show dhcp_server ipv4 info Vlan1000
  +-----------+-----+------------+--------------+--------------+------------------------+
  |Interface  |Mode |Gateway     |Netmask       |Lease Time(s) |Rules                   |
  |-----------+-----+------------+--------------+----------- --+------------------------+
  |Vlan1000   |PORT |192.168.0.1 |255.255.255.0 |180           |Ethernet1 192.168.0.2   |
  |           |     |            |              |              |Ethernet2 192.168.0.3   |
  |           |     |            |              |              |Ethernet3 192.168.0.4   |
  +-----------+-----+------------+--------------+--------------+------------------------+

  show dhcp_server ipv4 info
  +-----------+-----+------------+--------------+--------------+------------------------+
  |Interface  |Mode |Gateway     |Netmask       |Lease Time(s) |Rules                   |
  |-----------+-----+------------+--------------+----------- --+------------------------+
  |Vlan1000   |PORT |192.168.0.1 |255.255.255.0 |180           |Ethernet1 192.168.0.2   |
  |           |     |            |              |              |Ethernet2 192.168.0.3   |
  |           |     |            |              |              |Ethernet3 192.168.0.4   |
  +-----------+-----+------------+--------------+--------------+------------------------+
  |Ethernet12 |PORT |192.168.0.1 |255.255.255.0 |180           |Ethernet12 192.168.0.10 |
  +-----------+-----+------------+--------------+--------------+------------------------+
  ```

**show dhcp_server counter**

This command is used to show dhcp_server counter
- Usage
  ```
  show dhcp_server ipv4 counter [<interface>]
  ```

- Example
  ```
  show dhcp_server ipv4 counter Vlan1000
  +-----------+------------+------+
  |Interface  |Packet Type |Count |
  |-----------+------------+------+
  |Vlan1000   |DISCOVER    |15    |
  |           |OFFER       |15    |
  |           |REQUEST     |15    |
  |           |ACK         |15    |
  +-----------+------------+------+

  show dhcp_server ipv4 counter
  +-----------+------------+------+
  |Interface  |Packet Type |Count |
  |-----------+------------+------+
  |Vlan1000   |DISCOVER    |15    |
  |           |OFFER       |15    |
  |           |REQUEST     |15    |
  |           |ACK         |15    |
  +-----------+------------+------+
  |Ethernet12 |DISCOVER    |15    |
  |           |OFFER       |15    |
  |           |REQUEST     |15    |
  |           |ACK         |15    |
  +-----------+------------+------+
  ```

**show dhcp_server lease**

This command is used to show dhcp_server lease
- Usage
  ```
  show dhcp_server ipv4 lease [<interface>]
  ```

- Example
  ```
  show dhcp_server ipv4 lease Vlan1000
  +-----------+------------------+------------+--------------------+--------------------+
  |Interface  |MAC Address       |IP          |Lease Start         |Lease End           |
  |-----------+------------------+------------+--------------------+--------------------+
  |Vlan1000   |2c:2c:2c:2c:2c:2c |192.168.0.1 |2023-02-02 10:00:00 |2023-02-02 10:15:00 |
  |           |2b:2b:2b:2b:2b:2b |192.168.0.1 |2023-02-02 10:00:00 |2023-02-02 10:15:00 |
  +-----------+------------------+------------+--------------------+--------------------+

  show dhcp_server ipv4 lease
  +-----------+------------------+------------+--------------------+--------------------+
  |Interface  |MAC Address       |IP          |Lease Start         |Lease End           |
  |-----------+------------------+------------+--------------------+--------------------+
  |Vlan1000   |2c:2c:2c:2c:2c:2c |192.168.0.1 |2023-02-02 10:00:00 |2023-02-02 10:15:00 |
  |           |2b:2b:2b:2b:2b:2b |192.168.0.1 |2023-02-02 10:00:00 |2023-02-02 10:15:00 |
  +-----------+------------------+------------+--------------------+--------------------+
  |Vlan1001   |2e:2e:2e:2e:2e:2e |192.168.0.1 |2023-02-02 10:00:00 |2023-02-02 10:15:00 |
  |-----------+------------------+------------+--------------------+--------------------+
### 3.5.3 Clear CLI
**sonic-clear dhcp_server ipv4 counter**
This command is used to clear dhcp_server counter
- Usage
  ```
  sonic-clear dhcp_server ipv4 counter [<interface>]
  ```

- Example
  ```
  sonic-clear dhcp_server ipv4 counter Vlan1000
  ```

# 4 Unit test
The Unit test case are as below:
| No |                Test case summary                          |
|:----------------------|:-----------------------------------------------------------|
| 1 | Verify that config add/del dhcp_server can work well |
| 2 | Verify that config dhcp_server info can work well |
| 3 | Verify that show dhcp_server info can work well |
